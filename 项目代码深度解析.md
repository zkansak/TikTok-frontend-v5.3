# TikTok å‰ç«¯é¡¹ç›®ä»£ç æ·±åº¦è§£æ

> æœ¬æ–‡æ¡£åŸºäºå…‹éš†çš„ä»“åº“ [NgHuuTrong/tiktok-frontend](https://github.com/NgHuuTrong/tiktok-frontend.git) è¿›è¡Œæ·±åº¦æ”¹é€ åçš„ä»£ç è§£æ

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#ä¸€é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆä¸æ¶æ„è®¾è®¡](#äºŒæŠ€æœ¯æ ˆä¸æ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒåŠŸèƒ½å®ç°](#ä¸‰æ ¸å¿ƒåŠŸèƒ½å®ç°)
4. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#å››æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
5. [ä»£ç ç»„ç»‡ä¸è®¾è®¡æ¨¡å¼](#äº”ä»£ç ç»„ç»‡ä¸è®¾è®¡æ¨¡å¼)
6. [æ”¹é€ ç‚¹ä¸ä¼˜åŒ–](#å…­æ”¹é€ ç‚¹ä¸ä¼˜åŒ–)

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ª TikTok é£æ ¼çš„å‰ç«¯åº”ç”¨ï¼Œä½¿ç”¨ React 18 æ„å»ºã€‚é¡¹ç›®ä»åŸå§‹ä»“åº“å…‹éš†åè¿›è¡Œäº†ä¸€ç³»åˆ—æ”¹é€ å’Œä¼˜åŒ–ï¼Œä¸»è¦å®ç°äº†ï¼š

- **è§†é¢‘æµæ— é™æ»šåŠ¨**ï¼šç±»ä¼¼ TikTok çš„å‚ç›´è§†é¢‘æµä½“éªŒ
- **è§†é¢‘è‡ªåŠ¨æ’­æ”¾æ§åˆ¶**ï¼šåŸºäºè§†å£å¯è§æ€§çš„æ™ºèƒ½æ’­æ”¾/æš‚åœ
- **å…¨å±è§†é¢‘æµè§ˆ**ï¼šæ”¯æŒæ‰‹åŠ¿æ»‘åŠ¨ã€é”®ç›˜å¯¼èˆª
- **è™šæ‹Ÿçª—å£æ¸²æŸ“**ï¼šä¼˜åŒ–é•¿åˆ—è¡¨æ€§èƒ½
- **æ»šåŠ¨ä½ç½®æ¢å¤**ï¼šæå‡ç”¨æˆ·ä½“éªŒ

### 1.2 é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ components/          # å¯å¤ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ VideoFeed/       # è§†é¢‘æµç»„ä»¶ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”œâ”€â”€ VideoItem/       # å•ä¸ªè§†é¢‘é¡¹
â”‚   â”œâ”€â”€ VideoFullscreenView/  # å…¨å±è§†é¢‘è§†å›¾
â”‚   â””â”€â”€ ...
â”œâ”€â”€ hooks/               # è‡ªå®šä¹‰ Hooks
â”‚   â”œâ”€â”€ useInfiniteScroll.js    # æ— é™æ»šåŠ¨
â”‚   â”œâ”€â”€ useVideoPlayer.js       # è§†é¢‘æ’­æ”¾æ§åˆ¶
â”‚   â”œâ”€â”€ useFullscreenNavigation.js  # å…¨å±å¯¼èˆª
â”‚   â””â”€â”€ ...
â”œâ”€â”€ pages/               # é¡µé¢ç»„ä»¶
â”‚   â”œâ”€â”€ Home/           # é¦–é¡µï¼ˆæ¨èè§†é¢‘æµï¼‰
â”‚   â”œâ”€â”€ Following/      # å…³æ³¨é¡µ
â”‚   â””â”€â”€ ...
â”œâ”€â”€ services/            # API æœåŠ¡å±‚
â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•°
â”œâ”€â”€ layouts/            # å¸ƒå±€ç»„ä»¶
â””â”€â”€ config/             # é…ç½®æ–‡ä»¶
```

---

## äºŒã€æŠ€æœ¯æ ˆä¸æ¶æ„è®¾è®¡

### 2.1 æŠ€æœ¯æ ˆ

**æ ¸å¿ƒæ¡†æ¶**
- React 18.2.0ï¼ˆæ”¯æŒ Concurrent Modeã€startTransition ç­‰æ–°ç‰¹æ€§ï¼‰
- React Router DOM 6.8.2

**æ ·å¼æ–¹æ¡ˆ**
- SCSS (Sass)
- CSS Modulesï¼ˆç»„ä»¶çº§æ ·å¼éš”ç¦»ï¼‰

**HTTP è¯·æ±‚**
- Axios 1.3.4

**UI å¢å¼º**
- Ant Design 5.28.1 - UI ç»„ä»¶åº“ï¼ˆå›¾æ ‡ã€éƒ¨åˆ†ç»„ä»¶ï¼‰
- Tippy.js 4.2.6 - å·¥å…·æç¤ºåº“
- Font Awesome - å›¾æ ‡åº“

**å·¥å…·åº“**
- classnames 2.3.2 - æ¡ä»¶ç±»åå·¥å…·
- dayjs 1.11.19 - æ—¥æœŸå¤„ç†åº“

**æ„å»ºå·¥å…·**
- Create React App (CRA)
- react-app-rewired + customize-craï¼ˆè‡ªå®šä¹‰é…ç½®ï¼‰

### 2.2 æ¶æ„è®¾è®¡åŸåˆ™

#### 2.2.1 ç»„ä»¶åŒ–è®¾è®¡

é¡¹ç›®é‡‡ç”¨**ç»„ä»¶åŒ–ã€æ¨¡å—åŒ–**çš„æ¶æ„ï¼š

- **åŸå­ç»„ä»¶**ï¼šButtonã€Imageã€Loading ç­‰åŸºç¡€ç»„ä»¶
- **ä¸šåŠ¡ç»„ä»¶**ï¼šVideoFeedã€VideoItem ç­‰ä¸šåŠ¡ç›¸å…³ç»„ä»¶
- **é¡µé¢ç»„ä»¶**ï¼šHomeã€Following ç­‰è·¯ç”±é¡µé¢
- **å¸ƒå±€ç»„ä»¶**ï¼šDefaultLayoutã€HeaderOnly ç­‰å¸ƒå±€å®¹å™¨

#### 2.2.2 å…³æ³¨ç‚¹åˆ†ç¦»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Pages (é¡µé¢å±‚)              â”‚
â”‚   - è·¯ç”±é…ç½®                         â”‚
â”‚   - é¡µé¢çº§çŠ¶æ€ç®¡ç†                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Components (ç»„ä»¶å±‚)            â”‚
â”‚   - UI æ¸²æŸ“                          â”‚
â”‚   - ç”¨æˆ·äº¤äº’                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Hooks (é€»è¾‘å±‚)                â”‚
â”‚   - ä¸šåŠ¡é€»è¾‘å°è£…                     â”‚
â”‚   - çŠ¶æ€ç®¡ç†                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Services (æœåŠ¡å±‚)               â”‚
â”‚   - API è°ƒç”¨                         â”‚
â”‚   - æ•°æ®è½¬æ¢                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2.3 æ•°æ®æµè®¾è®¡

é¡¹ç›®é‡‡ç”¨**å•å‘æ•°æ®æµ**ï¼š

1. **ç”¨æˆ·æ“ä½œ** â†’ è§¦å‘äº‹ä»¶
2. **äº‹ä»¶å¤„ç†** â†’ è°ƒç”¨ Hook æˆ– Service
3. **çŠ¶æ€æ›´æ–°** â†’ é€šè¿‡ useState/useReducer
4. **UI é‡æ¸²æŸ“** â†’ React è‡ªåŠ¨æ›´æ–°è§†å›¾

---

## ä¸‰ã€æ ¸å¿ƒåŠŸèƒ½å®ç°

### 3.1 æ— é™æ»šåŠ¨å®ç°ï¼ˆuseInfiniteScrollï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`src/hooks/useInfiniteScroll.js`

è¿™æ˜¯é¡¹ç›®çš„**æ ¸å¿ƒ Hook**ï¼Œå®ç°äº†é«˜æ€§èƒ½çš„æ— é™æ»šåŠ¨åŠ è½½ã€‚

#### 3.1.1 æŠ€æœ¯é€‰å‹ï¼šIntersectionObserver API

**ä¸ºä»€ä¹ˆé€‰æ‹© IntersectionObserverï¼Ÿ**

ä¼ ç»Ÿå®ç°æ–¹å¼ï¼ˆç›‘å¬ scroll äº‹ä»¶ï¼‰çš„é—®é¢˜ï¼š
- âŒ éœ€è¦é¢‘ç¹è®¡ç®—æ»šåŠ¨ä½ç½®
- âŒ é˜»å¡ä¸»çº¿ç¨‹ï¼Œå½±å“æ€§èƒ½
- âŒ ä»£ç å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™

IntersectionObserver çš„ä¼˜åŠ¿ï¼š
- âœ… æµè§ˆå™¨åŸç”Ÿ APIï¼Œæ€§èƒ½ä¼˜ç§€
- âœ… å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
- âœ… è‡ªåŠ¨è®¡ç®—å…ƒç´ å¯è§æ€§ï¼Œä»£ç ç®€æ´

#### 3.1.2 æ ¸å¿ƒå®ç°é€»è¾‘

```javascript
// åˆ›å»º IntersectionObserver å®ä¾‹
observerInstanceRef.current = new IntersectionObserver(
  (entries) => {
    const [entry] = entries;
    // å½“åº•éƒ¨å…ƒç´ è¿›å…¥è§†å£ï¼Œä¸”è¿˜æœ‰æ›´å¤šæ•°æ®æ—¶ï¼Œè§¦å‘åŠ è½½
    if (entry.isIntersecting && hasMore && !loading && !isLoadingRef.current) {
      const nextPage = page + 1;
      debouncedFetchMore(nextPage);
    }
  },
  {
    threshold: 0.1,        // 10% å¯è§æ—¶è§¦å‘
    rootMargin: '100px',    // æå‰100pxè§¦å‘ï¼Œä¼˜åŒ–ä½“éªŒ
  }
);
```

**å…³é”®å‚æ•°è¯´æ˜**ï¼š
- `threshold: 0.1`ï¼šå…ƒç´  10% å¯è§æ—¶è§¦å‘å›è°ƒ
- `rootMargin: '100px'`ï¼šæå‰ 100px è§¦å‘ï¼Œç”¨æˆ·æ„Ÿè§‰æ›´æµç•…

#### 3.1.3 é˜²æŠ–æœºåˆ¶

```javascript
const debouncedFetchMore = useCallback(
  (pageNum, currentRetryCount = 0) => {
    if (debounceTimerRef.current) {
      clearTimeout(debounceTimerRef.current);
    }

    debounceTimerRef.current = setTimeout(async () => {
      // æ‰§è¡ŒåŠ è½½é€»è¾‘
      await fetchMore(pageNum);
    }, debounceDelay); // é»˜è®¤ 300ms
  },
  [fetchMore, hasMore, debounceDelay]
);
```

**é˜²æŠ–çš„ä½œç”¨**ï¼š
- é¿å…ç”¨æˆ·å¿«é€Ÿæ»šåŠ¨æ—¶é¢‘ç¹è§¦å‘è¯·æ±‚
- å‡å°‘æœåŠ¡å™¨å‹åŠ›
- æå‡ç”¨æˆ·ä½“éªŒ

#### 3.1.4 é”™è¯¯é‡è¯•æœºåˆ¶

```javascript
catch (err) {
  setError(err);
  
  // è‡ªåŠ¨é‡è¯•æœºåˆ¶
  const nextRetryCount = currentRetryCount + 1;
  if (nextRetryCount <= maxRetries) { // é»˜è®¤æœ€å¤šé‡è¯•3æ¬¡
    setTimeout(() => {
      debouncedFetchMore(pageNum, nextRetryCount);
    }, retryDelay); // é»˜è®¤å»¶è¿Ÿ1ç§’
  }
}
```

**é‡è¯•ç­–ç•¥**ï¼š
- æœ€å¤šé‡è¯• 3 æ¬¡
- æ¯æ¬¡é‡è¯•å»¶è¿Ÿ 1 ç§’ï¼ˆæŒ‡æ•°é€€é¿å¯ä¼˜åŒ–ï¼‰
- æˆåŠŸåé‡ç½®é‡è¯•è®¡æ•°

#### 3.1.5 ä½¿ç”¨ç¤ºä¾‹

```javascript
const { observerRef, error, retry } = useInfiniteScroll(
  fetchMore,      // åŠ è½½æ›´å¤šæ•°æ®çš„å‡½æ•°
  hasMore,        // æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
  loading,        // æ˜¯å¦æ­£åœ¨åŠ è½½
  {
    threshold: 0.1,
    rootMargin: '100px',
    debounceDelay: 300,
    maxRetries: 3,
    retryDelay: 1000,
  }
);

// åœ¨ JSX ä¸­ä½¿ç”¨
<div ref={observerRef}>åŠ è½½æ›´å¤š...</div>
```

---

### 3.2 è™šæ‹Ÿçª—å£æœºåˆ¶ï¼ˆæ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/VideoFeed/VideoFeed.js` (182-209è¡Œ)

#### 3.2.1 é—®é¢˜èƒŒæ™¯

å½“è§†é¢‘åˆ—è¡¨å¾ˆé•¿æ—¶ï¼ˆå¦‚ 1000+ ä¸ªè§†é¢‘ï¼‰ï¼Œå¦‚æœå…¨éƒ¨æ¸²æŸ“ä¼šå¯¼è‡´ï¼š
- âŒ DOM èŠ‚ç‚¹è¿‡å¤šï¼Œå†…å­˜å ç”¨é«˜
- âŒ æ»šåŠ¨æ€§èƒ½ä¸‹é™ï¼Œå‡ºç°å¡é¡¿
- âŒ é¦–å±æ¸²æŸ“æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ

#### 3.2.2 è§£å†³æ–¹æ¡ˆï¼šåŒå‘çª—å£ç­–ç•¥

é¡¹ç›®å®ç°äº†**è™šæ‹Ÿçª—å£æ¸²æŸ“**ï¼Œåªæ¸²æŸ“å¯è§åŒºåŸŸé™„è¿‘çš„è§†é¢‘ï¼š

```182:209:src/components/VideoFeed/VideoFeed.js
  // DOM èŠ‚ç‚¹é™åˆ¶ï¼šä½¿ç”¨åŒå‘çª—å£ç­–ç•¥ï¼Œä¿ç•™å½“å‰å¯è§åŒºåŸŸé™„è¿‘çš„é¡¹ç›®
  // å¿…é¡»åœ¨æ‰€æœ‰æ—©æœŸè¿”å›ä¹‹å‰è°ƒç”¨ï¼Œéµå®ˆ React Hooks è§„åˆ™
  const displayedItems = useMemo(() => {
    if (!maxItems || state.feedList.length <= maxItems) {
      return state.feedList;
    }

    // åŒå‘çª—å£ç­–ç•¥ï¼šä»¥å½“å‰å¯è§ç´¢å¼•ä¸ºä¸­å¿ƒï¼Œä¿ç•™å‰åå„ maxItems/2 ä¸ªé¡¹ç›®
    const currentIndex = currentVisibleIndex;
    const windowSize = maxItems;
    const halfWindow = Math.floor(windowSize / 2);
    
    // è®¡ç®—çª—å£èŒƒå›´
    let startIndex = Math.max(0, currentIndex - halfWindow);
    let endIndex = Math.min(state.feedList.length, startIndex + windowSize);
    
    // å¦‚æœæ¥è¿‘æœ«å°¾ï¼Œè°ƒæ•´èµ·å§‹ä½ç½®ä»¥ç¡®ä¿çª—å£å¤§å°
    if (endIndex === state.feedList.length) {
      startIndex = Math.max(0, endIndex - windowSize);
    }
    
    // æå–çª—å£å†…çš„é¡¹ç›®
    const windowItems = state.feedList.slice(startIndex, endIndex);
    
    // è¿”å›çª—å£é¡¹ç›®ï¼ŒåŒæ—¶ä¿ç•™åŸå§‹ç´¢å¼•ä¿¡æ¯ï¼ˆç”¨äºåç»­æŸ¥æ‰¾ï¼‰
    return windowItems.map((item, index) => ({
      ...item,
      _originalIndex: startIndex + index, // ä¿å­˜åŸå§‹ç´¢å¼•
    }));
  }, [state.feedList, maxItems, currentVisibleIndex]);
```

**æ ¸å¿ƒæ€è·¯**ï¼š
1. ä»¥å½“å‰å¯è§è§†é¢‘ä¸ºä¸­å¿ƒ
2. ä¿ç•™å‰åå„ `maxItems/2` ä¸ªè§†é¢‘
3. çª—å£å¤–çš„è§†é¢‘ä¸æ¸²æŸ“ï¼Œå‡å°‘ DOM èŠ‚ç‚¹

**ç¤ºä¾‹**ï¼š
- å‡è®¾ `maxItems = 20`ï¼Œå½“å‰å¯è§ç´¢å¼•ä¸º 100
- çª—å£èŒƒå›´ï¼š90-110ï¼ˆå‰åå„ 10 ä¸ªï¼‰
- åªæ¸²æŸ“è¿™ 20 ä¸ªè§†é¢‘ï¼Œè€Œä¸æ˜¯å…¨éƒ¨ 1000 ä¸ª

#### 3.2.3 å¯è§æ€§è·Ÿè¸ª

ä½¿ç”¨ IntersectionObserver è·Ÿè¸ªå½“å‰å¯è§çš„è§†é¢‘ï¼š

```226:282:src/components/VideoFeed/VideoFeed.js
  // ä½¿ç”¨ IntersectionObserver è·Ÿè¸ªå¯è§çš„è§†é¢‘
  useEffect(() => {
    if (!onVideoVisibilityChange || displayedItems.length === 0) return;

    const observers = new Map();
    
    // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
    const timeoutId = setTimeout(() => {
      displayedItems.forEach((item, index) => {
        const videoId = item.aweme_id || item.id || index;
        const videoElement = videoRefs.current.get(videoId);
        if (!videoElement) return;

        const observer = new IntersectionObserver(
          (intersectionEntries) => {
            intersectionEntries.forEach((entry) => {
              if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
                // æŸ¥æ‰¾åœ¨å®Œæ•´feedListä¸­çš„ç´¢å¼•
                // ä¼˜å…ˆä½¿ç”¨ _originalIndexï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ findIndex
                let originalIndex = item._originalIndex;
                if (originalIndex === undefined || originalIndex < 0) {
                  originalIndex = state.feedList.findIndex(
                    (feed) => 
                      (feed.aweme_id && item.aweme_id && feed.aweme_id === item.aweme_id) ||
                      (feed.id && item.id && feed.id === item.id) ||
                      (feed === item)
                  );
                }
                
                if (originalIndex >= 0) {
                  currentVisibleIndexRef.current = originalIndex;
                  debouncedSetCurrentVisibleIndex(originalIndex); // é˜²æŠ–æ›´æ–° state ä»¥è§¦å‘çª—å£é‡æ–°è®¡ç®—
                  onVideoVisibilityChange(originalIndex);
                }
              }
            });
          },
          {
            threshold: [0, 0.25, 0.5, 0.75, 1],
            rootMargin: '-20% 0px -20% 0px', // åªæœ‰ä¸­å¿ƒåŒºåŸŸå¯è§æ—¶æ‰è§¦å‘
          }
        );

        observer.observe(videoElement);
        observers.set(videoId, observer);
      });
    }, 100);

    return () => {
      clearTimeout(timeoutId);
      observers.forEach((observer) => observer.disconnect());
      // æ¸…ç†é˜²æŠ–å®šæ—¶å™¨
      if (debounceTimerRef.current) {
        clearTimeout(debounceTimerRef.current);
      }
    };
  }, [displayedItems, state.feedList, onVideoVisibilityChange, debouncedSetCurrentVisibleIndex]);
```

**å…³é”®ç‚¹**ï¼š
- `rootMargin: '-20% 0px -20% 0px'`ï¼šåªæœ‰ä¸­å¿ƒåŒºåŸŸå¯è§æ—¶æ‰è§¦å‘
- é˜²æŠ–æ›´æ–°ï¼šé¿å…é¢‘ç¹è§¦å‘çª—å£é‡æ–°è®¡ç®—ï¼ˆ200ms é˜²æŠ–ï¼‰

#### 3.2.4 æ€§èƒ½æå‡

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- âœ… DOM èŠ‚ç‚¹ä» 1000+ å‡å°‘åˆ° 20 ä¸ªï¼ˆå‡è®¾ maxItems=20ï¼‰
- âœ… å†…å­˜å ç”¨é™ä½ 95%+
- âœ… æ»šåŠ¨æµç•…åº¦æ˜¾è‘—æå‡
- âœ… é¦–å±æ¸²æŸ“æ—¶é—´å‡å°‘

---

### 3.3 è§†é¢‘è‡ªåŠ¨æ’­æ”¾æ§åˆ¶

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/VideoItem/VideoCard/VideoCard.js` (219-263è¡Œ)

#### 3.3.1 æ ¸å¿ƒåŸç†

ä½¿ç”¨ IntersectionObserver ç›‘å¬è§†é¢‘å…ƒç´ ï¼Œæ ¹æ®å¯è§æ¯”ä¾‹è‡ªåŠ¨æ’­æ”¾/æš‚åœã€‚

#### 3.3.2 å®ç°ç»†èŠ‚

```219:263:src/components/VideoItem/VideoCard/VideoCard.js
  // IntersectionObserver: æ»‘åˆ°å³æ’­æ”¾ï¼Œç¦»å¼€å³æš‚åœ
  useEffect(() => {
    if (!containerRef.current || !videoElement.current) return;
    
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const ratio = entry.intersectionRatio || 0;
          const currentVideo = videoElement.current;
          if (!currentVideo) return;
          
          if (!entry.isIntersecting) {
            // ç¦»å¼€è§†å£ï¼šè‡ªåŠ¨æš‚åœ
            if (isPlayingRef.current) {
              videoPlayer.pause();
            }
            return;
          }

          // å¦‚æœç”¨æˆ·æ‰‹åŠ¨æš‚åœäº†ï¼Œä¸è¦è‡ªåŠ¨æ’­æ”¾
          if (userPausedRef.current) {
            return;
          }

          // è¿›å…¥è§†å£ï¼šå¯è§æ¯”ä¾‹è¶…è¿‡ 0.6 æ—¶è‡ªåŠ¨æ’­æ”¾
          // ä½¿ç”¨æ»åé˜ˆå€¼é¿å…é¢‘ç¹åˆ‡æ¢ï¼š>=0.6 æ’­æ”¾, <=0.45 æš‚åœ
          if (!isPlayingRef.current && ratio >= 0.6) {
            videoPlayer.play();
          } else if (isPlayingRef.current && ratio <= 0.45) {
            videoPlayer.pause();
          }
        });
      },
      { 
        threshold: [0, 0.25, 0.45, 0.6, 0.7, 1], // åŒ…å« 0.6 é˜ˆå€¼ç”¨äºæ’­æ”¾è§¦å‘
        rootMargin: '100px' // æå‰åŠ è½½ï¼Œä¼˜åŒ–ä½“éªŒ
      }
    );
    
    observer.observe(containerRef.current);
    
    return () => {
      observer.disconnect();
    };
  }, [videoPlayer]);
```

#### 3.3.3 å…³é”®è®¾è®¡ç‚¹

**1. æ»åé˜ˆå€¼ï¼ˆHysteresisï¼‰**
- æ’­æ”¾é˜ˆå€¼ï¼š`ratio >= 0.6`
- æš‚åœé˜ˆå€¼ï¼š`ratio <= 0.45`
- **ä½œç”¨**ï¼šé¿å…åœ¨ä¸´ç•Œå€¼é™„è¿‘é¢‘ç¹åˆ‡æ¢æ’­æ”¾/æš‚åœ

**2. ç”¨æˆ·æ‰‹åŠ¨æš‚åœä¿æŠ¤**
```javascript
if (userPausedRef.current) {
  return; // ç”¨æˆ·æ‰‹åŠ¨æš‚åœåï¼Œä¸è‡ªåŠ¨æ’­æ”¾
}
```
- å°Šé‡ç”¨æˆ·æ„å›¾ï¼Œé¿å…å¹²æ‰°

**3. æå‰åŠ è½½**
- `rootMargin: '100px'`ï¼šæå‰ 100px å¼€å§‹åŠ è½½
- ç”¨æˆ·æ»šåŠ¨æ—¶è§†é¢‘å·²å‡†å¤‡å¥½ï¼Œä½“éªŒæ›´æµç•…

#### 3.3.4 è§†é¢‘æ’­æ”¾å™¨ Hook

**æ–‡ä»¶ä½ç½®**ï¼š`src/hooks/useVideoPlayer.js`

å°è£…äº†è§†é¢‘æ’­æ”¾çš„æ ¸å¿ƒé€»è¾‘ï¼š

```1:93:src/hooks/useVideoPlayer.js
import { useEffect, useState } from 'react';

function useVideoPlayer(videoElement) {
  const [playerState, setPlayerState] = useState({
    isPlaying: false,
    isMuted: false, // é»˜è®¤ä¸é™éŸ³
    progress: 0,
  });

  // Handle Playing
  const togglePlay = () => {
    setPlayerState((prevState) => ({
      ...prevState,
      isPlaying: !prevState.isPlaying,
    }));
  };
  const play = () => {
    setPlayerState((s) => ({ ...s, isPlaying: true }));
  };
  const pause = () => {
    setPlayerState((s) => ({ ...s, isPlaying: false }));
  };
  useEffect(() => {
    const el = videoElement.current;
    if (!el) return;
    if (playerState.isPlaying) {
      const maybePromise = el.play();
      if (maybePromise && typeof maybePromise.then === 'function') {
        maybePromise.catch(() => {
          // å¿½ç•¥ç”±å¿«é€Ÿåˆ‡æ¢æ’­æ”¾/æš‚åœå¼•èµ·çš„ä¸­æ–­é”™è¯¯
        });
      }
    } else {
      el.pause();
    }
  }, [playerState.isPlaying, videoElement]);

  // Handle Muted
  const toggleMuted = () => {
    setPlayerState((prevState) => ({
      ...prevState,
      isMuted: !prevState.isMuted,
    }));
  };
  useEffect(() => {
    videoElement.current.muted = playerState.isMuted;
  }, [playerState.isMuted, videoElement]);

  // Handle Progress
  const handleOnTimeUpdate = () => {
    const el = videoElement.current;
    if (!el || !el.duration) return;
    const progress = (el.currentTime / el.duration) * 100;
    setPlayerState((prevState) => {
      if (progress >= 100) {
        return {
          ...prevState,
          progress: 100,
          isPlaying: false,
        };
      }
      return {
        ...prevState,
        progress,
      };
    });
  };
  const handleVideoProgress = (event) => {
    const el = videoElement.current;
    if (!el || !el.duration) return;
    const manualChange = Number(event.target.value);
    const newTime = (el.duration / 100) * manualChange;
    
    // ç›´æ¥è®¾ç½®è§†é¢‘æ—¶é—´ï¼Œå®ç°æ‹–æ‹½è·³è½¬
    el.currentTime = newTime;
    
    setPlayerState((prevState) => ({
      ...prevState,
      progress: manualChange,
    }));
  };
  return {
    playerState,
    togglePlay,
    play,
    pause,
    toggleMuted,
    handleOnTimeUpdate,
    handleVideoProgress,
  };
}

export default useVideoPlayer;
```

**åŠŸèƒ½**ï¼š
- æ’­æ”¾/æš‚åœæ§åˆ¶
- é™éŸ³/å–æ¶ˆé™éŸ³
- è¿›åº¦è·Ÿè¸ªå’Œè·³è½¬
- è‡ªåŠ¨å¤„ç†æ’­æ”¾é”™è¯¯

---

### 3.4 å…¨å±å¯¼èˆªå®ç°

**æ–‡ä»¶ä½ç½®**ï¼š`src/hooks/useFullscreenNavigation.js`

#### 3.4.1 åŠŸèƒ½æ¦‚è¿°

ç®¡ç†å…¨å±æ¨¡å¼ä¸‹çš„è§†é¢‘åˆ‡æ¢ï¼Œæ”¯æŒï¼š
- åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª/ä¸Šä¸€ä¸ªè§†é¢‘
- é˜²æ­¢å¿«é€Ÿè¿ç»­åˆ‡æ¢ï¼ˆå†·å´æœºåˆ¶ï¼‰
- åˆ‡æ¢åŠ¨ç”»çŠ¶æ€ç®¡ç†
- æ‹–æ‹½åˆ‡æ¢ï¼ˆæ— åŠ¨ç”»ï¼‰

#### 3.4.2 æ ¸å¿ƒå®ç°

```1:140:src/hooks/useFullscreenNavigation.js
import { useState, useCallback, useRef, useEffect } from 'react';

/**
 * å…¨å±æ¨¡å¼å¯¼èˆª Hook
 * ç®¡ç†å½“å‰è§†é¢‘ç´¢å¼•ã€åˆ‡æ¢åŠ¨ç”»ã€é¢„åŠ è½½ç­‰
 */
function useFullscreenNavigation(initialIndex = 0, totalItems = 0) {
  const [currentIndex, setCurrentIndex] = useState(initialIndex);
  const [isTransitioning, setIsTransitioning] = useState(false);
  const transitionTimerRef = useRef(null);
  const lastSwitchTimeRef = useRef(0); // è®°å½•ä¸Šæ¬¡åˆ‡æ¢æ—¶é—´ï¼Œé˜²æ­¢å¿«é€Ÿè¿ç»­åˆ‡æ¢
  const switchCooldownRef = useRef(400); // åˆ‡æ¢å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œä¸åŠ¨ç”»æ—¶é•¿ä¸€è‡´

  // ç«‹å³å®Œæˆè¿‡æ¸¡ï¼ˆç”¨äºæ‹–æ‹½åˆ‡æ¢ï¼‰
  const completeTransition = useCallback(() => {
    if (transitionTimerRef.current) {
      clearTimeout(transitionTimerRef.current);
      transitionTimerRef.current = null;
    }
    setIsTransitioning(false);
  }, []);

  // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè§†é¢‘
  const goToNext = useCallback((skipCooldown = false) => {
    const now = Date.now();
    // è¾¹ç•Œæ£€æŸ¥
    if (currentIndex >= totalItems - 1) return;
    
    // é˜²æ­¢è¿ç»­å¿«é€Ÿåˆ‡æ¢ï¼šå¦‚æœæ­£åœ¨è¿‡æ¸¡ä¸­æˆ–å†·å´æœŸå†…ï¼Œç›´æ¥è¿”å›
    // å¦‚æœæ˜¯æ‹–æ‹½åˆ‡æ¢ï¼ˆskipCooldown = trueï¼‰ï¼Œå…è®¸ç»§ç»­
    if (!skipCooldown) {
      if (isTransitioning) return;
      
      // æ£€æŸ¥å†·å´æ—¶é—´ï¼šç¡®ä¿è‡³å°‘é—´éš” switchCooldownRef.current æ¯«ç§’æ‰èƒ½åˆ‡æ¢
      if (now - lastSwitchTimeRef.current < switchCooldownRef.current) {
        return;
      }
    }
    
    setIsTransitioning(true);
    lastSwitchTimeRef.current = now;
    setCurrentIndex((prev) => prev + 1);
    
    // å¦‚æœæ˜¯æ‹–æ‹½åˆ‡æ¢ï¼Œç«‹å³å®Œæˆè¿‡æ¸¡ï¼ˆæ— åŠ¨ç”»ï¼‰
    if (skipCooldown) {
      // ä½¿ç”¨ setTimeout ç¡®ä¿çŠ¶æ€æ›´æ–°åå†é‡ç½®
      setTimeout(() => {
        completeTransition();
      }, 0);
    } else {
      // åŠ¨ç”»å®Œæˆåé‡ç½®çŠ¶æ€ - ç»Ÿä¸€ä½¿ç”¨ 400ms çš„åŠ¨ç”»æ—¶é•¿
      if (transitionTimerRef.current) {
        clearTimeout(transitionTimerRef.current);
      }
      transitionTimerRef.current = setTimeout(() => {
        setIsTransitioning(false);
      }, 400); // åŠ¨ç”»æ—¶é•¿ 400msï¼Œä¸ CSS åŠ¨ç”»ä¸€è‡´
    }
  }, [currentIndex, totalItems, isTransitioning, completeTransition]);

  // åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªè§†é¢‘
  const goToPrevious = useCallback((skipCooldown = false) => {
    const now = Date.now();
    // è¾¹ç•Œæ£€æŸ¥
    if (currentIndex <= 0) return;
    
    // é˜²æ­¢è¿ç»­å¿«é€Ÿåˆ‡æ¢ï¼šå¦‚æœæ­£åœ¨è¿‡æ¸¡ä¸­æˆ–å†·å´æœŸå†…ï¼Œç›´æ¥è¿”å›
    // å¦‚æœæ˜¯æ‹–æ‹½åˆ‡æ¢ï¼ˆskipCooldown = trueï¼‰ï¼Œå…è®¸ç»§ç»­
    if (!skipCooldown) {
      if (isTransitioning) return;
      
      // æ£€æŸ¥å†·å´æ—¶é—´ï¼šç¡®ä¿è‡³å°‘é—´éš” switchCooldownRef.current æ¯«ç§’æ‰èƒ½åˆ‡æ¢
      if (now - lastSwitchTimeRef.current < switchCooldownRef.current) {
        return;
      }
    }
    
    setIsTransitioning(true);
    lastSwitchTimeRef.current = now;
    setCurrentIndex((prev) => prev - 1);
    
    // å¦‚æœæ˜¯æ‹–æ‹½åˆ‡æ¢ï¼Œç«‹å³å®Œæˆè¿‡æ¸¡ï¼ˆæ— åŠ¨ç”»ï¼‰
    if (skipCooldown) {
      // ä½¿ç”¨ setTimeout ç¡®ä¿çŠ¶æ€æ›´æ–°åå†é‡ç½®
      setTimeout(() => {
        completeTransition();
      }, 0);
    } else {
      if (transitionTimerRef.current) {
        clearTimeout(transitionTimerRef.current);
      }
      transitionTimerRef.current = setTimeout(() => {
        setIsTransitioning(false);
      }, 400); // åŠ¨ç”»æ—¶é•¿ 400msï¼Œä¸ CSS åŠ¨ç”»ä¸€è‡´
    }
  }, [currentIndex, isTransitioning, completeTransition]);

  // è·³è½¬åˆ°æŒ‡å®šç´¢å¼•
  const goToIndex = useCallback((index) => {
    if (isTransitioning || index < 0 || index >= totalItems) return;
    
    setIsTransitioning(true);
    setCurrentIndex(index);
    
    if (transitionTimerRef.current) {
      clearTimeout(transitionTimerRef.current);
    }
    transitionTimerRef.current = setTimeout(() => {
      setIsTransitioning(false);
    }, 350);
  }, [totalItems, isTransitioning]);

  // å½“ totalItems å˜åŒ–æ—¶ï¼Œç¡®ä¿ currentIndex ä¸è¶…å‡ºèŒƒå›´
  useEffect(() => {
    if (currentIndex >= totalItems && totalItems > 0) {
      setCurrentIndex(totalItems - 1);
    }
  }, [totalItems, currentIndex]);

  // æ¸…ç†å®šæ—¶å™¨
  useEffect(() => {
    return () => {
      if (transitionTimerRef.current) {
        clearTimeout(transitionTimerRef.current);
      }
    };
  }, []);

  return {
    currentIndex,
    isTransitioning,
    goToNext,
    goToPrevious,
    goToIndex,
    hasNext: currentIndex < totalItems - 1,
    hasPrevious: currentIndex > 0,
  };
}

export default useFullscreenNavigation;
```

#### 3.4.3 å…³é”®è®¾è®¡

**1. å†·å´æœºåˆ¶**
- é˜²æ­¢ç”¨æˆ·å¿«é€Ÿè¿ç»­åˆ‡æ¢å¯¼è‡´åŠ¨ç”»æ··ä¹±
- å†·å´æ—¶é—´ï¼š400msï¼ˆä¸åŠ¨ç”»æ—¶é•¿ä¸€è‡´ï¼‰

**2. æ‹–æ‹½åˆ‡æ¢ä¼˜åŒ–**
- `skipCooldown = true`ï¼šæ‹–æ‹½æ—¶è·³è¿‡å†·å´ï¼Œç«‹å³åˆ‡æ¢
- æ— åŠ¨ç”»ï¼Œå“åº”æ›´å¿«

**3. è¾¹ç•Œæ£€æŸ¥**
- é˜²æ­¢ç´¢å¼•è¶Šç•Œ
- è‡ªåŠ¨è°ƒæ•´åˆ°æœ‰æ•ˆèŒƒå›´

---

### 3.5 çŠ¶æ€ç®¡ç†ï¼šuseReducer

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/VideoFeed/VideoFeed.js` (12-59è¡Œ)

#### 3.5.1 ä¸ºä»€ä¹ˆä½¿ç”¨ useReducerï¼Ÿ

å½“çŠ¶æ€é€»è¾‘å¤æ‚æ—¶ï¼Œ`useReducer` æ¯”å¤šä¸ª `useState` æ›´é€‚åˆï¼š

**useState çš„é—®é¢˜**ï¼š
- å¤šä¸ªç›¸å…³çŠ¶æ€éœ€è¦åˆ†åˆ«ç®¡ç†
- çŠ¶æ€æ›´æ–°é€»è¾‘åˆ†æ•£
- å®¹æ˜“å‡ºç°çŠ¶æ€ä¸ä¸€è‡´

**useReducer çš„ä¼˜åŠ¿**ï¼š
- çŠ¶æ€é›†ä¸­ç®¡ç†
- æ›´æ–°é€»è¾‘ç»Ÿä¸€ï¼ˆreducer å‡½æ•°ï¼‰
- ä¾¿äºè°ƒè¯•å’Œç»´æŠ¤

#### 3.5.2 çŠ¶æ€ç»“æ„

```12:21:src/components/VideoFeed/VideoFeed.js
// åˆ†é¡µçŠ¶æ€ç®¡ç† reducer
const initialState = {
  feedList: [],
  loading: true,
  loadingMore: false,
  hasMore: true,
  error: null,
  page: 1,
  pageSize: 10,
};
```

#### 3.5.3 Reducer å®ç°

```23:59:src/components/VideoFeed/VideoFeed.js
function feedReducer(state, action) {
  switch (action.type) {
    case 'FETCH_START':
      return {
        ...state,
        loading: action.isInitial ? true : false,
        loadingMore: !action.isInitial,
        error: null,
      };
    case 'FETCH_SUCCESS':
      return {
        ...state,
        loading: false,
        loadingMore: false,
        feedList: action.isInitial
          ? action.data
          : [...state.feedList, ...action.data],
        hasMore: action.hasMore,
        page: action.page,
        error: null,
      };
    case 'FETCH_ERROR':
      return {
        ...state,
        loading: false,
        loadingMore: false,
        error: action.error,
      };
    case 'RESET':
      return {
        ...initialState,
        pageSize: state.pageSize,
      };
    default:
      return state;
  }
}
```

**Action ç±»å‹**ï¼š
- `FETCH_START`ï¼šå¼€å§‹åŠ è½½ï¼ˆåŒºåˆ†åˆå§‹åŠ è½½å’ŒåŠ è½½æ›´å¤šï¼‰
- `FETCH_SUCCESS`ï¼šåŠ è½½æˆåŠŸï¼ˆè¿½åŠ æ•°æ®æˆ–æ›¿æ¢æ•°æ®ï¼‰
- `FETCH_ERROR`ï¼šåŠ è½½å¤±è´¥
- `RESET`ï¼šé‡ç½®çŠ¶æ€

#### 3.5.4 ä½¿ç”¨ç¤ºä¾‹

```javascript
const [state, dispatch] = useReducer(feedReducer, {
  ...initialState,
  pageSize,
});

// å¼€å§‹åŠ è½½
dispatch({ type: 'FETCH_START', isInitial: true });

// åŠ è½½æˆåŠŸ
dispatch({
  type: 'FETCH_SUCCESS',
  data: newData,
  hasMore: true,
  page: 2,
  isInitial: false,
});
```

---

## å››ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 4.1 æ¸²æŸ“ä¼˜åŒ–

#### 4.1.1 useMemo ç¼“å­˜è®¡ç®—ç»“æœ

**åº”ç”¨åœºæ™¯**ï¼šè™šæ‹Ÿçª—å£è®¡ç®—ã€æ•°æ®è½¬æ¢

```javascript
const displayedItems = useMemo(() => {
  // å¤æ‚çš„çª—å£è®¡ç®—é€»è¾‘
  // åªæœ‰å½“ä¾èµ–é¡¹å˜åŒ–æ—¶æ‰é‡æ–°è®¡ç®—
}, [state.feedList, maxItems, currentVisibleIndex]);
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- é¿å…ä¸å¿…è¦çš„é‡å¤è®¡ç®—
- å‡å°‘ç»„ä»¶é‡æ¸²æŸ“

#### 4.1.2 useCallback ç¼“å­˜å‡½æ•°

**åº”ç”¨åœºæ™¯**ï¼šäº‹ä»¶å¤„ç†å‡½æ•°ã€ä¼ é€’ç»™å­ç»„ä»¶çš„å›è°ƒ

```javascript
const debouncedSetCurrentVisibleIndex = useCallback((index) => {
  // é˜²æŠ–æ›´æ–°é€»è¾‘
}, []);
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- é¿å…å­ç»„ä»¶ä¸å¿…è¦çš„é‡æ¸²æŸ“
- ä¿æŒå‡½æ•°å¼•ç”¨ç¨³å®š

#### 4.1.3 React.memo ç»„ä»¶ç¼“å­˜

**åº”ç”¨åœºæ™¯**ï¼šçº¯å±•ç¤ºç»„ä»¶ã€åˆ—è¡¨é¡¹ç»„ä»¶

```javascript
const VideoItem = React.memo(({ data }) => {
  // ç»„ä»¶å®ç°
}, (prevProps, nextProps) => {
  // è‡ªå®šä¹‰æ¯”è¾ƒé€»è¾‘
  return prevProps.data.id === nextProps.data.id;
});
```

### 4.2 ç½‘ç»œä¼˜åŒ–

#### 4.2.1 é˜²æŠ–å’ŒèŠ‚æµ

**é˜²æŠ–ï¼ˆDebounceï¼‰**ï¼š
- æ— é™æ»šåŠ¨åŠ è½½ï¼š300ms é˜²æŠ–
- æ»šåŠ¨ä½ç½®ä¿å­˜ï¼š100ms é˜²æŠ–
- å¯è§æ€§ç´¢å¼•æ›´æ–°ï¼š200ms é˜²æŠ–

**èŠ‚æµï¼ˆThrottleï¼‰**ï¼š
- æ»šåŠ¨äº‹ä»¶ï¼šä½¿ç”¨ `requestAnimationFrame` ä¼˜åŒ–

#### 4.2.2 åˆ†é¡µåŠ è½½

**ç­–ç•¥**ï¼š
- åˆå§‹åŠ è½½ï¼š10 æ¡æ•°æ®
- æ»šåŠ¨åŠ è½½ï¼šæ¯æ¬¡ 10 æ¡
- é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®

#### 4.2.3 é”™è¯¯é‡è¯•æœºåˆ¶

```javascript
// è‡ªåŠ¨é‡è¯•ï¼Œæœ€å¤š 3 æ¬¡
if (nextRetryCount <= maxRetries) {
  setTimeout(() => {
    debouncedFetchMore(pageNum, nextRetryCount);
  }, retryDelay);
}
```

### 4.3 å†…å­˜ä¼˜åŒ–

#### 4.3.1 è™šæ‹Ÿçª—å£æ¸²æŸ“

**æ•ˆæœ**ï¼š
- DOM èŠ‚ç‚¹ä» 1000+ å‡å°‘åˆ° 20 ä¸ª
- å†…å­˜å ç”¨é™ä½ 95%+

#### 4.3.2 åŠæ—¶æ¸…ç†èµ„æº

```javascript
useEffect(() => {
  const observer = new IntersectionObserver(/* ... */);
  
  return () => {
    observer.disconnect(); // æ¸…ç† Observer
    clearTimeout(timer);   // æ¸…ç†å®šæ—¶å™¨
  };
}, []);
```

### 4.4 ç”¨æˆ·ä½“éªŒä¼˜åŒ–

#### 4.4.1 æ»šåŠ¨ä½ç½®æ¢å¤

**æ–‡ä»¶ä½ç½®**ï¼š`src/utils/scrollPosition.js`ã€`src/App.js`

**å®ç°**ï¼š
- ä½¿ç”¨ `sessionStorage` ä¿å­˜æ»šåŠ¨ä½ç½®
- é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¢å¤
- é˜²æŠ–ä¿å­˜ï¼ˆ100msï¼‰

```1:58:src/utils/scrollPosition.js
// æ»šåŠ¨ä½ç½®ç®¡ç†å·¥å…·

const SCROLL_POSITION_KEY = 'scroll_positions';

/**
 * ä¿å­˜å½“å‰é¡µé¢çš„æ»šåŠ¨ä½ç½®
 * @param {string} pathname - è·¯ç”±è·¯å¾„
 * @param {number} scrollY - æ»šåŠ¨ä½ç½®
 */
export const saveScrollPosition = (pathname, scrollY) => {
  try {
    const positions = JSON.parse(sessionStorage.getItem(SCROLL_POSITION_KEY) || '{}');
    positions[pathname] = scrollY;
    sessionStorage.setItem(SCROLL_POSITION_KEY, JSON.stringify(positions));
  } catch (error) {
    console.error('Error saving scroll position:', error);
  }
};

/**
 * è·å–ä¿å­˜çš„æ»šåŠ¨ä½ç½®
 * @param {string} pathname - è·¯ç”±è·¯å¾„
 * @returns {number} æ»šåŠ¨ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å› 0
 */
export const getScrollPosition = (pathname) => {
  try {
    const positions = JSON.parse(sessionStorage.getItem(SCROLL_POSITION_KEY) || '{}');
    return positions[pathname] || 0;
  } catch (error) {
    console.error('Error getting scroll position:', error);
    return 0;
  }
};

/**
 * æ¸…é™¤æŒ‡å®šè·¯å¾„çš„æ»šåŠ¨ä½ç½®
 * @param {string} pathname - è·¯ç”±è·¯å¾„
 */
export const clearScrollPosition = (pathname) => {
  try {
    const positions = JSON.parse(sessionStorage.getItem(SCROLL_POSITION_KEY) || '{}');
    delete positions[pathname];
    sessionStorage.setItem(SCROLL_POSITION_KEY, JSON.stringify(positions));
  } catch (error) {
    console.error('Error clearing scroll position:', error);
  }
};

/**
 * æ¸…é™¤æ‰€æœ‰æ»šåŠ¨ä½ç½®
 */
export const clearAllScrollPositions = () => {
  try {
    sessionStorage.removeItem(SCROLL_POSITION_KEY);
  } catch (error) {
    console.error('Error clearing all scroll positions:', error);
  }
};
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ sessionStorageï¼Ÿ**
- ä¼šè¯çº§å­˜å‚¨ï¼Œå…³é—­æ ‡ç­¾é¡µåè‡ªåŠ¨æ¸…é™¤
- æ¯” localStorage æ›´è½»é‡
- é€‚åˆä¸´æ—¶çŠ¶æ€ä¿å­˜

#### 4.4.2 éª¨æ¶å±åŠ è½½

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/Skeleton/VideoSkeleton.js`

**ä½œç”¨**ï¼š
- æå‡æ„ŸçŸ¥æ€§èƒ½
- å‡å°‘å¸ƒå±€æŠ–åŠ¨ï¼ˆCLSï¼‰

#### 4.4.3 æå‰åŠ è½½ï¼ˆPreloadingï¼‰

**ç­–ç•¥**ï¼š
- `rootMargin: '100px'`ï¼šæå‰ 100px è§¦å‘åŠ è½½
- è§†é¢‘é¢„åŠ è½½ï¼š`preload="metadata"`

---

## äº”ã€ä»£ç ç»„ç»‡ä¸è®¾è®¡æ¨¡å¼

### 5.1 ç›®å½•ç»“æ„è®¾è®¡

```
src/
â”œâ”€â”€ components/          # å¯å¤ç”¨ç»„ä»¶ï¼ˆæŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡ï¼‰
â”‚   â”œâ”€â”€ VideoFeed/       # è§†é¢‘æµç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ VideoFeed.js
â”‚   â”‚   â”œâ”€â”€ VideoFeed.module.scss
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â””â”€â”€ ...
â”œâ”€â”€ hooks/               # è‡ªå®šä¹‰ Hooksï¼ˆæŒ‰åŠŸèƒ½åˆ†ç±»ï¼‰
â”‚   â”œâ”€â”€ useInfiniteScroll.js
â”‚   â”œâ”€â”€ useVideoPlayer.js
â”‚   â””â”€â”€ ...
â”œâ”€â”€ services/            # API æœåŠ¡å±‚ï¼ˆæŒ‰ä¸šåŠ¡æ¨¡å—ï¼‰
â”‚   â”œâ”€â”€ feedService.js
â”‚   â”œâ”€â”€ searchService.js
â”‚   â””â”€â”€ ...
â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•°ï¼ˆé€šç”¨åŠŸèƒ½ï¼‰
â”‚   â”œâ”€â”€ httpRequest.js
â”‚   â”œâ”€â”€ scrollPosition.js
â”‚   â””â”€â”€ ...
â””â”€â”€ pages/              # é¡µé¢ç»„ä»¶ï¼ˆæŒ‰è·¯ç”±ï¼‰
    â”œâ”€â”€ Home/
    â”œâ”€â”€ Following/
    â””â”€â”€ ...
```

**è®¾è®¡åŸåˆ™**ï¼š
- **æŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡**ï¼šç›¸å…³æ–‡ä»¶æ”¾åœ¨ä¸€èµ·
- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæ–‡ä»¶åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
- **æ˜“äºæŸ¥æ‰¾**ï¼šç›®å½•ç»“æ„æ¸…æ™°

### 5.2 æœåŠ¡å±‚æŠ½è±¡

**æ–‡ä»¶ä½ç½®**ï¼š`src/services/feedService.js`

**è®¾è®¡æ¨¡å¼**ï¼šæœåŠ¡å±‚æ¨¡å¼ï¼ˆService Layer Patternï¼‰

```1:90:src/services/feedService.js
import * as httpRequest from '~/utils/httpRequest';

/**
 * è·å– Feed æµæ•°æ®
 * @param {string} region - åœ°åŒºä»£ç ï¼Œé»˜è®¤ 'VN'
 * @param {string} device_id - è®¾å¤‡ IDï¼Œé»˜è®¤ '7214293347836528130'
 * @param {number} page - é¡µç ï¼Œä» 1 å¼€å§‹ï¼Œé»˜è®¤ 1
 * @param {number} pageSize - æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 10
 * @returns {Promise} è¿”å› Feed æ•°æ®
 */
export const getFeed = async (
  region = 'VN',
  device_id = '7214293347836528130',
  page = 1,
  pageSize = 10
) => {
  const feedOptions = {
    method: 'GET',
    url: 'https://tiktok-all-in-one.p.rapidapi.com/feed',
    params: {
      region,
      device_id,
      // å¦‚æœ API æ”¯æŒåˆ†é¡µå‚æ•°ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
      // page,
      // page_size: pageSize,
    },
    headers: {
      'X-RapidAPI-Key': '4ad34b516cmsh9be8d0d889bb84cp1030f9jsn2446e27d5d3a',
      'X-RapidAPI-Host': 'tiktok-all-in-one.p.rapidapi.com',
    },
  };
  const data = await httpRequest.get(feedOptions);
  return data;
};

/**
 * æ¨¡æ‹Ÿåˆ†é¡µè·å– Feed æ•°æ®ï¼ˆç”¨äºæœ¬åœ°æµ‹è¯•ï¼‰
 * ä» fakeFeedAPI ä¸­åˆ†é¡µè¿”å›æ•°æ®
 * æ”¯æŒå¾ªç¯åŠ è½½ï¼šå½“åŠ è½½å®Œæ‰€æœ‰æ•°æ®åï¼Œé‡æ–°ä»ç¬¬ä¸€é¡µå¼€å§‹
 * @param {number} page - é¡µç ï¼Œä» 1 å¼€å§‹
 * @param {number} pageSize - æ¯é¡µæ•°é‡
 * @param {boolean} loop - æ˜¯å¦å¾ªç¯åŠ è½½ï¼Œé»˜è®¤ true
 * @returns {Promise<{data: Array, hasMore: boolean, total: number}>}
 */
export const getFeedPaginated = async (page = 1, pageSize = 10, loop = true) => {
  // åŠ¨æ€å¯¼å…¥ï¼Œé¿å…åœ¨æœåŠ¡ç«¯æ‰§è¡Œæ—¶å‡ºé”™
  const fakeFeedAPI = await import('~/assets/json/fakeFeedAPI.json');
  const allData = fakeFeedAPI.default || fakeFeedAPI;
  const totalItems = allData.length;
  
  let startIndex, endIndex, paginatedData, hasMore;
  
  if (loop) {
    // å¾ªç¯æ¨¡å¼ï¼šä½¿ç”¨æ¨¡è¿ç®—å®ç°å¾ªç¯
    const actualIndex = ((page - 1) * pageSize) % totalItems;
    startIndex = actualIndex;
    endIndex = actualIndex + pageSize;
    
    if (endIndex <= totalItems) {
      // ä¸éœ€è¦å¾ªç¯ï¼Œç›´æ¥åˆ‡ç‰‡
      paginatedData = allData.slice(startIndex, endIndex);
    } else {
      // éœ€è¦å¾ªç¯ï¼šå…ˆå–åˆ°æœ«å°¾ï¼Œå†ä»å¼€å¤´å–å‰©ä½™éƒ¨åˆ†
      const firstPart = allData.slice(startIndex);
      const remaining = endIndex - totalItems;
      const secondPart = allData.slice(0, remaining);
      paginatedData = [...firstPart, ...secondPart];
    }
    
    // å¾ªç¯æ¨¡å¼ä¸‹ï¼Œå§‹ç»ˆæœ‰æ›´å¤šæ•°æ®
    hasMore = true;
  } else {
    // éå¾ªç¯æ¨¡å¼ï¼šæ­£å¸¸åˆ†é¡µ
    startIndex = (page - 1) * pageSize;
    endIndex = startIndex + pageSize;
    paginatedData = allData.slice(startIndex, endIndex);
    hasMore = endIndex < totalItems;
  }

  // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
  await new Promise((resolve) => setTimeout(resolve, 500));

  return {
    data: paginatedData,
    hasMore,
    total: totalItems,
    page,
    pageSize,
  };
};
```

**ä¼˜åŠ¿**ï¼š
- **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šAPI è°ƒç”¨é€»è¾‘ä¸ç»„ä»¶åˆ†ç¦»
- **æ˜“äºæµ‹è¯•**ï¼šå¯ä»¥è½»æ¾ mock æœåŠ¡
- **æ˜“äºç»´æŠ¤**ï¼šAPI å˜æ›´åªéœ€ä¿®æ”¹æœåŠ¡å±‚
- **ä»£ç å¤ç”¨**ï¼šå¤šä¸ªç»„ä»¶å¯ä»¥å…±äº«æœåŠ¡

### 5.3 è‡ªå®šä¹‰ Hooks æ¨¡å¼

**è®¾è®¡åŸåˆ™**ï¼š
- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ª Hook åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
- **å¯å¤ç”¨æ€§**ï¼šå¯ä»¥åœ¨å¤šä¸ªç»„ä»¶ä¸­ä½¿ç”¨
- **æ˜“äºæµ‹è¯•**ï¼šé€»è¾‘ä¸ UI åˆ†ç¦»

**ç¤ºä¾‹**ï¼š
- `useInfiniteScroll`ï¼šæ— é™æ»šåŠ¨é€»è¾‘
- `useVideoPlayer`ï¼šè§†é¢‘æ’­æ”¾æ§åˆ¶
- `useFullscreenNavigation`ï¼šå…¨å±å¯¼èˆª

### 5.4 ç»„ä»¶è®¾è®¡æ¨¡å¼

#### 5.4.1 å®¹å™¨ç»„ä»¶ vs å±•ç¤ºç»„ä»¶

**å®¹å™¨ç»„ä»¶**ï¼ˆContainer Componentsï¼‰ï¼š
- è´Ÿè´£æ•°æ®è·å–å’ŒçŠ¶æ€ç®¡ç†
- ä¾‹å¦‚ï¼š`VideoFeed`ã€`Home`

**å±•ç¤ºç»„ä»¶**ï¼ˆPresentational Componentsï¼‰ï¼š
- åªè´Ÿè´£ UI æ¸²æŸ“
- ä¾‹å¦‚ï¼š`VideoCard`ã€`Button`

#### 5.4.2 å—æ§ç»„ä»¶ vs éå—æ§ç»„ä»¶

**å—æ§ç»„ä»¶**ï¼š
- çŠ¶æ€ç”±çˆ¶ç»„ä»¶ç®¡ç†
- ä¾‹å¦‚ï¼š`VideoFeed` çš„ `dataSource` prop

**éå—æ§ç»„ä»¶**ï¼š
- çŠ¶æ€ç”±ç»„ä»¶å†…éƒ¨ç®¡ç†
- ä¾‹å¦‚ï¼š`VideoCard` çš„æ’­æ”¾çŠ¶æ€

### 5.5 çŠ¶æ€ç®¡ç†æ¨¡å¼

#### 5.5.1 æœ¬åœ°çŠ¶æ€ï¼ˆLocal Stateï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç»„ä»¶å†…éƒ¨çŠ¶æ€
- ä¸éœ€è¦è·¨ç»„ä»¶å…±äº«

**å·¥å…·**ï¼š
- `useState`ï¼šç®€å•çŠ¶æ€
- `useReducer`ï¼šå¤æ‚çŠ¶æ€

#### 5.5.2 æå‡çŠ¶æ€ï¼ˆLifting State Upï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- å¤šä¸ªç»„ä»¶éœ€è¦å…±äº«çŠ¶æ€
- ä¾‹å¦‚ï¼š`Home` ç»„ä»¶ç®¡ç† `currentVideoIndex`

#### 5.5.3 çŠ¶æ€æå‡ç¤ºä¾‹

```1:177:src/pages/Home/index.js
import { useState, useCallback, useEffect, useRef } from 'react';
import classNames from 'classnames/bind';

import VideoFeed from '~/components/VideoFeed';
import VideoFullscreenView from '~/components/VideoFullscreenView';
import { getFeedPaginated } from '~/services/feedService';
import { transformVideoList } from '~/utils/dataTransform';
import styles from './Home.module.scss';

const cx = classNames.bind(styles);

// æ¨¡å¼ç±»å‹
const VIEW_MODE = {
  LIST: 'list',
  FULLSCREEN: 'fullscreen',
};

function Home() {
  const [viewMode, setViewMode] = useState(VIEW_MODE.LIST);
  const [feedList, setFeedList] = useState([]);
  const [loading, setLoading] = useState(true);
  const [loadingMore, setLoadingMore] = useState(false);
  const [hasMore, setHasMore] = useState(true);
  const [page, setPage] = useState(1);
  const [currentVideoIndex, setCurrentVideoIndex] = useState(0); // å½“å‰å¯è§çš„è§†é¢‘ç´¢å¼•
  const [scrollToIndex, setScrollToIndex] = useState(null); // è¦æ»šåŠ¨åˆ°çš„è§†é¢‘ç´¢å¼•
  const previousViewModeRef = useRef(VIEW_MODE.LIST);

  // æ•°æ®æºï¼šä½¿ç”¨åˆ†é¡µ API
  const dataSource = useCallback(async (pageNum = 1, pageSize = 10) => {
    // ä½¿ç”¨åˆ†é¡µæœåŠ¡è·å–æ•°æ®
    const result = await getFeedPaginated(pageNum, pageSize);
    return {
      data: result.data,
      hasMore: result.hasMore,
      total: result.total,
    };
  }, []);

  // æ•°æ®è½¬æ¢å‡½æ•°
  const transformData = useCallback((data) => {
    return transformVideoList(data);
  }, []);

  // åŠ è½½æ•°æ®
  const loadData = useCallback(
    async (pageNum = 1, isInitial = false) => {
      if (isInitial) {
        setLoading(true);
      } else {
        setLoadingMore(true);
      }

      try {
        const result = await dataSource(pageNum, 10);
        const transformedData = transformData(result.data);

        if (isInitial) {
          setFeedList(transformedData);
        } else {
          setFeedList((prev) => [...prev, ...transformedData]);
        }

        setHasMore(result.hasMore);
        setPage(pageNum);
      } catch (error) {
        console.error('Error loading feed data:', error);
      } finally {
        setLoading(false);
        setLoadingMore(false);
      }
    },
    [dataSource, transformData]
  );

  // åˆå§‹åŠ è½½
  useEffect(() => {
    loadData(1, true);
  }, [loadData]);

  // åŠ è½½æ›´å¤šï¼ˆç”¨äºå…¨å±æ¨¡å¼ï¼‰
  const handleLoadMore = useCallback(() => {
    if (!loadingMore && hasMore) {
      loadData(page + 1, false);
    }
  }, [loadData, page, loadingMore, hasMore]);

  // åˆ‡æ¢æ¨¡å¼
  const toggleViewMode = useCallback(() => {
    setViewMode((prev) => {
      const newMode = prev === VIEW_MODE.LIST ? VIEW_MODE.FULLSCREEN : VIEW_MODE.LIST;
      previousViewModeRef.current = prev;
      
      // å¦‚æœä»åˆ—è¡¨æ¨¡å¼åˆ‡æ¢åˆ°å…¨å±æ¨¡å¼ï¼Œä¿å­˜å½“å‰è§†é¢‘ç´¢å¼•
      if (prev === VIEW_MODE.LIST && newMode === VIEW_MODE.FULLSCREEN) {
        // currentVideoIndex å·²ç»æ˜¯æœ€æ–°çš„ï¼Œç›´æ¥ä½¿ç”¨
      }
      
      // å¦‚æœä»å…¨å±æ¨¡å¼åˆ‡æ¢å›åˆ—è¡¨æ¨¡å¼ï¼Œè®¾ç½®æ»šåŠ¨ä½ç½®
      if (prev === VIEW_MODE.FULLSCREEN && newMode === VIEW_MODE.LIST) {
        // è®¾ç½®è¦æ»šåŠ¨åˆ°çš„ç´¢å¼•ï¼Œä»¥ä¾¿åˆ—è¡¨æ¨¡å¼æ»šåŠ¨åˆ°å¯¹åº”ä½ç½®
        setScrollToIndex(currentVideoIndex);
        // æ»šåŠ¨å®Œæˆåé‡ç½® scrollToIndex
        setTimeout(() => {
          setScrollToIndex(null);
        }, 1000);
      }
      
      return newMode;
    });
  }, [currentVideoIndex]);

  // åˆ—è¡¨æ¨¡å¼çš„æ•°æ®æºï¼ˆç”¨äº VideoFeedï¼‰
  // å¦‚æœfeedListå·²æœ‰æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨feedListï¼Œå¦åˆ™ä½¿ç”¨dataSource
  const listDataSource = useCallback(
    async (pageNum = 1, pageSize = 10) => {
      // å¦‚æœå·²ç»æœ‰æ•°æ®ä¸”æ˜¯ç¬¬ä¸€é¡µï¼Œç›´æ¥è¿”å›å·²æœ‰æ•°æ®
      if (pageNum === 1 && feedList.length > 0) {
        return {
          data: feedList.slice(0, pageSize),
          hasMore: feedList.length > pageSize || hasMore,
          total: feedList.length,
        };
      }
      
      const result = await dataSource(pageNum, pageSize);
      return {
        data: result.data,
        hasMore: result.hasMore,
        total: result.total,
      };
    },
    [dataSource, feedList, hasMore]
  );

  return (
    <div className={cx('wrapper')}>
      {/* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */}
      <button className={cx('mode-toggle')} onClick={toggleViewMode} aria-label="Toggle view mode">
        {viewMode === VIEW_MODE.LIST ? (
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 4h4v4H4V4zm6 0h10v4H10V4zm-6 6h4v4H4v-4zm6 0h10v4H10v-4zm-6 6h4v4H4v-4zm6 0h10v4H10v-4z" />
          </svg>
        ) : (
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 4h16v16H4V4zm2 2v12h12V6H6z" />
          </svg>
        )}
      </button>

      {/* æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒç»„ä»¶ */}
      {viewMode === VIEW_MODE.LIST ? (
        <VideoFeed
          dataSource={listDataSource}
          transformData={transformData}
          emptyMessage="No videos available"
          pageSize={10}
          enableInfiniteScroll={true}
          maxItems={null}
          onVideoVisibilityChange={setCurrentVideoIndex}
          scrollToIndex={scrollToIndex}
        />
      ) : (
        <VideoFullscreenView
          feedList={feedList}
          onLoadMore={handleLoadMore}
          hasMore={hasMore}
          loadingMore={loadingMore}
          initialIndex={currentVideoIndex}
          onVideoIndexChange={setCurrentVideoIndex}
        />
      )}
    </div>
  );
}

export default Home;
```

**è®¾è®¡è¦ç‚¹**ï¼š
- `Home` ç»„ä»¶ä½œä¸ºå®¹å™¨ï¼Œç®¡ç†å…±äº«çŠ¶æ€
- `currentVideoIndex` åœ¨åˆ—è¡¨æ¨¡å¼å’Œå…¨å±æ¨¡å¼é—´å…±äº«
- æ¨¡å¼åˆ‡æ¢æ—¶ä¿æŒè§†é¢‘ç´¢å¼•åŒæ­¥

---

## å…­ã€æ”¹é€ ç‚¹ä¸ä¼˜åŒ–

### 6.1 ä»åŸå§‹ä»“åº“çš„æ”¹é€ 

#### 6.1.1 æ— é™æ»šåŠ¨ä¼˜åŒ–

**åŸå§‹å®ç°**ï¼šå¯èƒ½ä½¿ç”¨ scroll äº‹ä»¶ç›‘å¬

**æ”¹é€ å**ï¼š
- âœ… ä½¿ç”¨ IntersectionObserver API
- âœ… æ·»åŠ é˜²æŠ–æœºåˆ¶
- âœ… æ·»åŠ é”™è¯¯é‡è¯•æœºåˆ¶

#### 6.1.2 è™šæ‹Ÿçª—å£æœºåˆ¶

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… å®ç°åŒå‘çª—å£ç­–ç•¥
- âœ… å¤§å¹…å‡å°‘ DOM èŠ‚ç‚¹
- âœ… æå‡é•¿åˆ—è¡¨æ€§èƒ½

#### 6.1.3 è§†é¢‘æ’­æ”¾æ§åˆ¶

**ä¼˜åŒ–ç‚¹**ï¼š
- âœ… æ»åé˜ˆå€¼é¿å…é¢‘ç¹åˆ‡æ¢
- âœ… ç”¨æˆ·æ‰‹åŠ¨æš‚åœä¿æŠ¤
- âœ… æå‰åŠ è½½ä¼˜åŒ–ä½“éªŒ

#### 6.1.4 æ»šåŠ¨ä½ç½®æ¢å¤

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… ä½¿ç”¨ sessionStorage ä¿å­˜ä½ç½®
- âœ… é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¢å¤
- âœ… é˜²æŠ–ä¿å­˜ä¼˜åŒ–æ€§èƒ½

#### 6.1.5 æ´»åŠ¨èµ„æºç®¡ç†ç³»ç»Ÿï¼ˆæ–°å¢ï¼‰â­ï¸â­ï¸

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… **æ´»åŠ¨ç®¡ç†æœåŠ¡**ï¼ˆactivityService.jsï¼‰ï¼š
  - æ´»åŠ¨æ•°æ®çš„å¢åˆ æ”¹æŸ¥ï¼ˆCRUDï¼‰
  - æ´»åŠ¨åˆ—è¡¨åˆ†é¡µã€ç­›é€‰ã€æœç´¢
  - æ‰¹é‡æ“ä½œï¼ˆæ‰¹é‡æ›´æ–°çŠ¶æ€ã€æ‰¹é‡åˆ é™¤ï¼‰
  - æ´»åŠ¨ç»Ÿè®¡ä¿¡æ¯
  - æŒ‰ä½ç½®å’Œç±»å‹è·å–æ´»åŠ¨èµ„æº
  - æ—¶é—´èŒƒå›´æ£€æŸ¥ï¼ˆè‡ªåŠ¨è¿‡æ»¤è¿‡æœŸæ´»åŠ¨ï¼‰
  
- âœ… **Banner è½®æ’­ç»„ä»¶**ï¼ˆBannerCarouselï¼‰ï¼š
  - è‡ªåŠ¨è½®æ’­åŠŸèƒ½
  - æ‰‹åŠ¨åˆ‡æ¢ï¼ˆå·¦å³æŒ‰é’®ã€æŒ‡ç¤ºå™¨ï¼‰
  - é¼ æ ‡æ‚¬åœæš‚åœ
  - æ€§èƒ½ä¼˜åŒ–ï¼ˆåªæ¸²æŸ“å¯è§çš„ Bannerï¼Œæå‡ LCPï¼‰
  - React.memo ä¼˜åŒ–é‡æ¸²æŸ“
  
- âœ… **å¼¹çª—ç»„ä»¶**ï¼ˆPopupï¼‰ï¼š
  - å¤šç§æ˜¾ç¤ºè§„åˆ™ï¼ˆé¦–æ¬¡è®¿é—®ã€æ¯æ¬¡ä¼šè¯ã€æ¯æ¬¡è®¿é—®ã€å§‹ç»ˆæ˜¾ç¤ºï¼‰
  - æœ¬åœ°å­˜å‚¨çŠ¶æ€ç®¡ç†ï¼ˆlocalStorage/sessionStorageï¼‰
  - å›¾ç‰‡é¢„åŠ è½½ä¼˜åŒ–
  - ç‚¹å‡»é®ç½©å±‚å…³é—­
  - é”™è¯¯å¤„ç†ï¼ˆå›¾ç‰‡åŠ è½½å¤±è´¥æ˜¾ç¤ºå ä½ç¬¦ï¼‰
  - React.memo ä¼˜åŒ–æ€§èƒ½

**å®ç°ä½ç½®**ï¼š
- `src/services/activityService.js` - æ´»åŠ¨ç®¡ç†æœåŠ¡
- `src/components/BannerCarousel/BannerCarousel.js` - Banner è½®æ’­ç»„ä»¶
- `src/components/Popup/Popup.js` - å¼¹çª—ç»„ä»¶
- `src/pages/Home/index.js` - æ´»åŠ¨èµ„æºåŠ è½½é€»è¾‘

#### 6.1.6 React 18 æ€§èƒ½ä¼˜åŒ–ï¼ˆæ–°å¢ï¼‰â­ï¸â­ï¸â­ï¸

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… **startTransition API**ï¼š
  - ç”¨äºæ ‡è®°éç´§æ€¥æ›´æ–°ï¼Œä¼˜å…ˆæ¸²æŸ“å…³é”®å†…å®¹ï¼ˆLCP å…ƒç´ ï¼‰
  - å»¶è¿ŸåŠ è½½éå…³é”®å†…å®¹ï¼Œä¸é˜»å¡é¦–å±æ¸²æŸ“
  - æå‡é¦–å±åŠ è½½æ€§èƒ½
  
- âœ… **é¦–å±æ€§èƒ½ä¼˜åŒ–ï¼ˆLCPä¼˜åŒ–ï¼‰**ï¼š
  - ä½¿ç”¨ `<link rel="preload">` é¢„åŠ è½½å…³é”®å›¾ç‰‡
  - ä½¿ç”¨ Image å¯¹è±¡é¢„åŠ è½½ï¼Œè®¾ç½® `fetchPriority="high"`
  - ä¼˜å…ˆåŠ è½½ LCP å…ƒç´ ï¼ˆé¡¶éƒ¨ Bannerï¼‰
  - ä½¿ç”¨ startTransition å»¶è¿Ÿè§†é¢‘æ•°æ®åŠ è½½

**å®ç°ä½ç½®**ï¼š
- `src/pages/Home/index.js` (135-189è¡Œ) - æ´»åŠ¨èµ„æºåŠ è½½å’Œ LCP ä¼˜åŒ–

#### 6.1.7 è·¯ç”±æ‡’åŠ è½½ï¼ˆæ–°å¢ï¼‰â­ï¸â­ï¸

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… æ‰€æœ‰è·¯ç”±é¡µé¢éƒ½ä½¿ç”¨ React.lazy æ‡’åŠ è½½
- âœ… ä½¿ç”¨ Suspense æä¾›åŠ è½½çŠ¶æ€
- âœ… å‡å°‘åˆå§‹åŒ…ä½“ç§¯ï¼Œæå‡é¦–å±åŠ è½½é€Ÿåº¦

**å®ç°ä½ç½®**ï¼š
- `src/routes/index.js` - æ‰€æœ‰é¡µé¢ç»„ä»¶éƒ½ä½¿ç”¨ lazy åŠ è½½

### 6.2 ä»£ç è´¨é‡æå‡

#### 6.2.1 ç±»å‹æ£€æŸ¥

**ä½¿ç”¨ PropTypes**ï¼š
```javascript
VideoFeed.propTypes = {
  dataSource: PropTypes.oneOfType([PropTypes.func, PropTypes.array]).isRequired,
  transformData: PropTypes.func,
  emptyMessage: PropTypes.string,
  pageSize: PropTypes.number,
  enableInfiniteScroll: PropTypes.bool,
  maxItems: PropTypes.number,
  onVideoVisibilityChange: PropTypes.func,
  scrollToIndex: PropTypes.number,
};
```

#### 6.2.2 é”™è¯¯å¤„ç†

**ç­–ç•¥**ï¼š
- Try-catch åŒ…è£¹å…³é”®é€»è¾‘
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- è‡ªåŠ¨é‡è¯•æœºåˆ¶

#### 6.2.3 ä»£ç æ³¨é‡Š

**è§„èŒƒ**ï¼š
- JSDoc æ³¨é‡Šè¯´æ˜å‡½æ•°ç”¨é€”
- å…³é”®é€»è¾‘æ·»åŠ è¡Œå†…æ³¨é‡Š
- å¤æ‚ç®—æ³•æ·»åŠ è¯´æ˜

### 6.3 æ€§èƒ½ä¼˜åŒ–æˆæœ

**é‡åŒ–æŒ‡æ ‡**ï¼š
- DOM èŠ‚ç‚¹ï¼šå‡å°‘ 95%+ï¼ˆè™šæ‹Ÿçª—å£ï¼‰
- å†…å­˜å ç”¨ï¼šé™ä½ 95%+
- æ»šåŠ¨æµç•…åº¦ï¼šæ˜¾è‘—æå‡
- é¦–å±æ¸²æŸ“ï¼šæ—¶é—´å‡å°‘

### 6.4 ç”¨æˆ·ä½“éªŒæå‡

**æ”¹è¿›ç‚¹**ï¼š
- âœ… æ»šåŠ¨ä½ç½®æ¢å¤
- âœ… éª¨æ¶å±åŠ è½½
- âœ… é”™è¯¯é‡è¯•æœºåˆ¶
- âœ… æå‰åŠ è½½ä¼˜åŒ–
- âœ… åˆ‡æ¢åŠ¨ç”»ä¼˜åŒ–

---

## ä¸ƒã€æ´»åŠ¨èµ„æºç®¡ç†ç³»ç»Ÿï¼ˆæ–°å¢ï¼‰â­ï¸â­ï¸

### 7.1 æ´»åŠ¨ç®¡ç†æœåŠ¡ï¼ˆactivityService.jsï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`src/services/activityService.js`

#### 7.1.1 åŠŸèƒ½æ¦‚è¿°

æ´»åŠ¨èµ„æºç®¡ç†ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„æ´»åŠ¨æ•°æ®ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

- **æ´»åŠ¨ CRUD æ“ä½œ**ï¼šåˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤æ´»åŠ¨
- **æ´»åŠ¨åˆ—è¡¨æŸ¥è¯¢**ï¼šåˆ†é¡µã€ç­›é€‰ã€æœç´¢
- **æ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡æ›´æ–°çŠ¶æ€ã€æ‰¹é‡åˆ é™¤
- **æ´»åŠ¨ç»Ÿè®¡**ï¼šç»Ÿè®¡å„ç±»æ´»åŠ¨æ•°é‡
- **æŒ‰ä½ç½®è·å–èµ„æº**ï¼šæ ¹æ®æŠ•æ”¾ä½ç½®è·å–æ´»åŠ¨èµ„æºï¼ˆç”¨äºå‰ç«¯å±•ç¤ºï¼‰

#### 7.1.2 æ ¸å¿ƒåŠŸèƒ½å®ç°

**1. æ´»åŠ¨åˆ—è¡¨æŸ¥è¯¢**

```286:286:src/services/activityService.js
export const getActiveResourcesByPlacement = async (placement, resourceType = null) => {
```

**åŠŸèƒ½**ï¼š
- æ ¹æ®æŠ•æ”¾ä½ç½®ï¼ˆplacementï¼‰å’Œèµ„æºç±»å‹ï¼ˆresourceTypeï¼‰è·å–æ´»åŠ¨èµ„æº
- è‡ªåŠ¨è¿‡æ»¤è¿‡æœŸæ´»åŠ¨ï¼ˆæ£€æŸ¥æ—¶é—´èŒƒå›´ï¼‰
- åªè¿”å›è¿›è¡Œä¸­çš„æ´»åŠ¨ï¼ˆstatus === 'active'ï¼‰
- æŒ‰ä¼˜å…ˆçº§æ’åº

**2. æ´»åŠ¨ CRUD æ“ä½œ**

```77:111:src/services/activityService.js
export const getActivityList = async (params = {}) => {
  const { page = 1, pageSize = 10, status, keyword } = params;

  // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
  await new Promise((resolve) => setTimeout(resolve, 300));

  let filteredData = [...mockActivities];

  // å…³é”®è¯æœç´¢ï¼ˆæ´»åŠ¨åç§°ã€æè¿°ï¼‰
  if (keyword) {
    const lowerKeyword = keyword.toLowerCase();
    filteredData = filteredData.filter(
      (item) =>
        item.name.toLowerCase().includes(lowerKeyword) ||
        (item.description && item.description.toLowerCase().includes(lowerKeyword))
    );
  }

  // çŠ¶æ€ç­›é€‰
  if (status) {
    filteredData = filteredData.filter((item) => item.status === status);
  }

  // åˆ†é¡µ
  const startIndex = (page - 1) * pageSize;
  const endIndex = startIndex + pageSize;
  const paginatedData = filteredData.slice(startIndex, endIndex);

  return {
    data: paginatedData,
    total: filteredData.length,
    page,
    pageSize,
  };
};
```

**åŠŸèƒ½**ï¼š
- æ”¯æŒåˆ†é¡µæŸ¥è¯¢
- æ”¯æŒçŠ¶æ€ç­›é€‰
- æ”¯æŒå…³é”®è¯æœç´¢ï¼ˆæ´»åŠ¨åç§°ã€æè¿°ï¼‰
- è¿”å›åˆ†é¡µæ•°æ®ã€æ€»æ•°ç­‰ä¿¡æ¯

### 7.2 Banner è½®æ’­ç»„ä»¶ï¼ˆBannerCarouselï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/BannerCarousel/BannerCarousel.js`

#### 7.2.1 åŠŸèƒ½æ¦‚è¿°

Banner è½®æ’­ç»„ä»¶å®ç°äº†é«˜æ€§èƒ½çš„ Banner è‡ªåŠ¨è½®æ’­åŠŸèƒ½ï¼š

- **è‡ªåŠ¨è½®æ’­**ï¼šå¯é…ç½®è‡ªåŠ¨æ’­æ”¾é—´éš”
- **æ‰‹åŠ¨åˆ‡æ¢**ï¼šæ”¯æŒå·¦å³æŒ‰é’®å’ŒæŒ‡ç¤ºå™¨åˆ‡æ¢
- **äº¤äº’ä¼˜åŒ–**ï¼šé¼ æ ‡æ‚¬åœæš‚åœã€æ‰‹åŠ¨åˆ‡æ¢åå»¶è¿Ÿæ¢å¤
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåªæ¸²æŸ“å¯è§çš„ Bannerï¼Œæå‡ LCP

#### 7.2.2 æ ¸å¿ƒå®ç°

**1. æ™ºèƒ½æ¸²æŸ“ç­–ç•¥**

```82:93:src/components/BannerCarousel/BannerCarousel.js
  // ä¼˜åŒ–ï¼šåªæ¸²æŸ“å½“å‰å’Œç›¸é‚»çš„ Bannerï¼Œå‡å°‘åˆå§‹æ¸²æŸ“è´Ÿæ‹…ï¼ˆæå‡ LCPï¼‰
  // ç¬¬ä¸€ä¸ª Bannerï¼ˆindex 0ï¼‰æ˜¯ LCP å…ƒç´ ï¼Œä¼˜å…ˆæ¸²æŸ“
  const visibleIndices = [];
  if (currentIndex === 0) {
    // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªï¼Œåªæ¸²æŸ“å‰ä¸¤ä¸ªï¼ˆå½“å‰å’Œä¸‹ä¸€ä¸ªï¼‰
    visibleIndices.push(0, 1);
  } else {
    // å¦åˆ™æ¸²æŸ“å‰ä¸€ä¸ªã€å½“å‰ã€ä¸‹ä¸€ä¸ª
    const prevIndex = (currentIndex - 1 + activities.length) % activities.length;
    const nextIndex = (currentIndex + 1) % activities.length;
    visibleIndices.push(prevIndex, currentIndex, nextIndex);
  }
```

**ä¼˜åŒ–ç‚¹**ï¼š
- åªæ¸²æŸ“å½“å‰å’Œç›¸é‚»çš„ Bannerï¼ˆæœ€å¤š 3 ä¸ªï¼‰
- ç¬¬ä¸€ä¸ª Banner ä¼˜å…ˆæ¸²æŸ“ï¼ˆLCP å…ƒç´ ï¼‰
- å‡å°‘åˆå§‹æ¸²æŸ“è´Ÿæ‹…ï¼Œæå‡ LCP æŒ‡æ ‡

**2. è‡ªåŠ¨æ’­æ”¾é€»è¾‘**

```57:70:src/components/BannerCarousel/BannerCarousel.js
  // è‡ªåŠ¨æ’­æ”¾
  useEffect(() => {
    if (autoPlayInterval > 0 && !isPaused && activities.length > 1) {
      intervalRef.current = setInterval(() => {
        setCurrentIndex((prev) => (prev + 1) % activities.length);
      }, autoPlayInterval);

      return () => {
        if (intervalRef.current) {
          clearInterval(intervalRef.current);
        }
      };
    }
  }, [autoPlayInterval, isPaused, activities?.length]);
```

**åŠŸèƒ½**ï¼š
- å¯é…ç½®è‡ªåŠ¨æ’­æ”¾é—´éš”ï¼ˆé»˜è®¤ 5000msï¼‰
- æ”¯æŒæš‚åœ/æ¢å¤ï¼ˆé¼ æ ‡æ‚¬åœã€æ‰‹åŠ¨åˆ‡æ¢ï¼‰
- è‡ªåŠ¨æ¸…ç†å®šæ—¶å™¨

### 7.3 å¼¹çª—ç»„ä»¶ï¼ˆPopupï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/Popup/Popup.js`

#### 7.3.1 åŠŸèƒ½æ¦‚è¿°

å¼¹çª—ç»„ä»¶å®ç°äº†çµæ´»çš„æ´»åŠ¨å¼¹çª—å±•ç¤ºåŠŸèƒ½ï¼š

- **å¤šç§æ˜¾ç¤ºè§„åˆ™**ï¼šé¦–æ¬¡è®¿é—®ã€æ¯æ¬¡ä¼šè¯ã€æ¯æ¬¡è®¿é—®ã€å§‹ç»ˆæ˜¾ç¤º
- **æœ¬åœ°å­˜å‚¨ç®¡ç†**ï¼šä½¿ç”¨ localStorage/sessionStorage ç¼“å­˜å…³é—­çŠ¶æ€
- **å›¾ç‰‡é¢„åŠ è½½**ï¼šè‡ªåŠ¨é¢„åŠ è½½å¼¹çª—å›¾ç‰‡
- **é”™è¯¯å¤„ç†**ï¼šå›¾ç‰‡åŠ è½½å¤±è´¥æ˜¾ç¤ºå ä½ç¬¦

#### 7.3.2 æ ¸å¿ƒå®ç°

**1. æ˜¾ç¤ºè§„åˆ™å¤„ç†**

```24:43:src/components/Popup/Popup.js
  // åˆå§‹å¯è§æ€§æ£€æŸ¥ï¼ˆåŒæ­¥æ‰§è¡Œï¼Œé¿å…å»¶è¿Ÿï¼‰
  const initialVisible = useMemo(() => {
    if (!activity) return false;
    
    // å¯¹äº 'every_visit' å’Œ 'always'ï¼Œç›´æ¥æ˜¾ç¤º
    if (activity.displayRule === 'every_visit' || activity.displayRule === 'always') {
      return true;
    }
    
    // å¯¹äºéœ€è¦æ£€æŸ¥ç¼“å­˜çš„è§„åˆ™ï¼ŒåŒæ­¥æ£€æŸ¥
    if (activity.displayRule === 'first_visit') {
      return !localStorage.getItem(storageKey);
    }
    
    if (activity.displayRule === 'once_per_session') {
      return !sessionStorage.getItem(storageKey);
    }
    
    return true;
  }, [activity, storageKey]);
```

**åŠŸèƒ½**ï¼š
- `first_visit`ï¼šåªåœ¨é¦–æ¬¡è®¿é—®æ—¶æ˜¾ç¤ºï¼Œä½¿ç”¨ localStorage ç¼“å­˜
- `once_per_session`ï¼šæ¯æ¬¡ä¼šè¯æ˜¾ç¤ºä¸€æ¬¡ï¼Œä½¿ç”¨ sessionStorage ç¼“å­˜
- `every_visit`ï¼šæ¯æ¬¡è®¿é—®éƒ½æ˜¾ç¤º
- `always`ï¼šå§‹ç»ˆæ˜¾ç¤º

**2. å…³é—­å¤„ç†**

```47:61:src/components/Popup/Popup.js
  const handleClose = useCallback(() => {
    setVisible(false);
    
    // æ ¹æ®æ˜¾ç¤ºè§„åˆ™å†³å®šæ˜¯å¦ç¼“å­˜å…³é—­çŠ¶æ€
    if (activity?.displayRule === 'first_visit') {
      // é¦–æ¬¡è®¿é—®ï¼šæ°¸ä¹…ç¼“å­˜
      localStorage.setItem(storageKey, 'true');
    } else if (activity?.displayRule === 'once_per_session') {
      // æ¯æ¬¡ä¼šè¯ï¼šsessionStorage
      sessionStorage.setItem(storageKey, 'true');
    }
    // 'every_visit' å’Œ 'always' ä¸ç¼“å­˜ï¼Œä¸‹æ¬¡è®¿é—®è¿˜ä¼šæ˜¾ç¤º

    if (onClose) onClose();
  }, [activity?.displayRule, storageKey, onClose]);
```

### 7.4 æ´»åŠ¨èµ„æºåŠ è½½ä¼˜åŒ–ï¼ˆHome ç»„ä»¶ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`src/pages/Home/index.js`

#### 7.4.1 LCP ä¼˜åŒ–ç­–ç•¥

**ä¼˜å…ˆåŠ è½½ LCP å…ƒç´ **ï¼š

```135:176:src/pages/Home/index.js
  // åŠ è½½æ´»åŠ¨èµ„æºï¼ˆä¼˜åŒ–LCPæ€§èƒ½ï¼‰
  const loadActivityResources = useCallback(async () => {
    try {
      // ä¼˜å…ˆåŠ è½½é¡¶éƒ¨Bannerï¼ˆLCPå…ƒç´ ï¼‰
      const topBannerData = await getActiveResourcesByPlacement('home_top', 'banner');
      
      // ç«‹å³è®¾ç½®é¡¶éƒ¨BannerçŠ¶æ€ï¼Œè§¦å‘æ¸²æŸ“
      if (topBannerData.length > 0) {
        const firstBanner = topBannerData[0];
        // ç«‹å³é¢„åŠ è½½ç¬¬ä¸€ä¸ªBannerå›¾ç‰‡ï¼ˆLCPå…ƒç´ ï¼‰ï¼Œåœ¨è®¾ç½®çŠ¶æ€ä¹‹å‰
        if (firstBanner?.resourceUrl) {
          preloadImage(firstBanner.resourceUrl);
        }
        // ç«‹å³è®¾ç½®çŠ¶æ€ï¼Œè§¦å‘ç»„ä»¶æ¸²æŸ“
        setTopBanners(topBannerData);
      }
      
      // å»¶è¿ŸåŠ è½½å…¶ä»–èµ„æºï¼Œä¸é˜»å¡LCPå…ƒç´ 
      // ä½¿ç”¨ startTransition å»¶è¿Ÿéå…³é”®å†…å®¹çš„æ›´æ–°ï¼Œä¼˜å…ˆæ¸²æŸ“ LCP å…ƒç´ 
      startTransition(async () => {
        const [bottomBannerData, popupData] = await Promise.all([
          getActiveResourcesByPlacement('home_bottom', 'banner'),
          getActiveResourcesByPlacement('home_center', 'popup'),
        ]);
        
        if (process.env.NODE_ENV === 'development') {
          console.log('ğŸ“¢ é¡¶éƒ¨Banneræ•°æ®:', topBannerData);
          console.log('ğŸ“¢ åº•éƒ¨Banneræ•°æ®:', bottomBannerData);
          console.log('ğŸ“¢ å¼¹çª—æ•°æ®:', popupData);
        }
        
        setBottomBanners(bottomBannerData);
        setPopups(popupData);
        
        // é¢„åŠ è½½å…¶ä»–å›¾ç‰‡ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œä¸é˜»å¡ LCPï¼‰
        bottomBannerData.forEach((banner) => preloadImage(banner?.resourceUrl));
        popupData.forEach((popup) => preloadImage(popup?.resourceUrl));
      });
    } catch (error) {
      console.error('âŒ åŠ è½½æ´»åŠ¨èµ„æºå¤±è´¥:', error);
    }
  }, [preloadImage]);
```

**ä¼˜åŒ–ç­–ç•¥**ï¼š
1. **ä¼˜å…ˆåŠ è½½é¡¶éƒ¨ Banner**ï¼ˆLCP å…ƒç´ ï¼‰
2. **å›¾ç‰‡é¢„åŠ è½½**ï¼šåœ¨è®¾ç½®çŠ¶æ€ä¹‹å‰é¢„åŠ è½½å›¾ç‰‡
3. **startTransition**ï¼šå»¶è¿ŸåŠ è½½éå…³é”®å†…å®¹ï¼ˆåº•éƒ¨ Bannerã€å¼¹çª—ï¼‰
4. **å¹¶è¡ŒåŠ è½½**ï¼šä½¿ç”¨ Promise.all å¹¶è¡ŒåŠ è½½å¤šä¸ªèµ„æº

**å›¾ç‰‡é¢„åŠ è½½ç­–ç•¥**ï¼š

```116:133:src/pages/Home/index.js
  // é¢„åŠ è½½å›¾ç‰‡ï¼ˆä½¿ç”¨å¤šç§æ–¹å¼ç¡®ä¿å°½æ—©åŠ è½½ï¼‰
  const preloadImage = useCallback((url) => {
    if (!url) return;
    
    // æ–¹å¼1: ä½¿ç”¨ link preloadï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    const link = document.createElement('link');
    link.rel = 'preload';
    link.as = 'image';
    link.href = url;
    link.fetchPriority = 'high';
    document.head.appendChild(link);
    
    // æ–¹å¼2: ä½¿ç”¨ Image å¯¹è±¡é¢„åŠ è½½ï¼ˆç¡®ä¿å›¾ç‰‡ç¼“å­˜ï¼‰
    const img = new Image();
    img.src = url;
    img.loading = 'eager';
    img.fetchPriority = 'high';
  }, []);
```

**åŒé‡é¢„åŠ è½½**ï¼š
- `<link rel="preload">`ï¼šæµè§ˆå™¨åŸç”Ÿé¢„åŠ è½½ï¼Œæœ€é«˜ä¼˜å…ˆçº§
- `Image` å¯¹è±¡é¢„åŠ è½½ï¼šç¡®ä¿å›¾ç‰‡ç¼“å­˜ï¼Œè®¾ç½® `fetchPriority="high"`

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒæŠ€æœ¯ç‚¹

1. **IntersectionObserver API**ï¼šæ— é™æ»šåŠ¨ã€å¯è§æ€§æ£€æµ‹
2. **è™šæ‹Ÿçª—å£æ¸²æŸ“**ï¼šæ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒ
3. **useReducer**ï¼šå¤æ‚çŠ¶æ€ç®¡ç†
4. **è‡ªå®šä¹‰ Hooks**ï¼šé€»è¾‘å¤ç”¨
5. **æœåŠ¡å±‚æŠ½è±¡**ï¼šå…³æ³¨ç‚¹åˆ†ç¦»
6. **æ´»åŠ¨èµ„æºç®¡ç†**ï¼šå®Œæ•´çš„ CRUD ç³»ç»Ÿå’Œèµ„æºåŠ è½½ï¼ˆæ–°å¢ï¼‰â­ï¸â­ï¸
7. **React 18 æ€§èƒ½ä¼˜åŒ–**ï¼šstartTransitionã€LCP ä¼˜åŒ–ï¼ˆæ–°å¢ï¼‰â­ï¸â­ï¸â­ï¸

### 8.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **æ¸²æŸ“ä¼˜åŒ–**ï¼šuseMemoã€useCallbackã€React.memo
2. **ç½‘ç»œä¼˜åŒ–**ï¼šé˜²æŠ–ã€èŠ‚æµã€åˆ†é¡µåŠ è½½
3. **å†…å­˜ä¼˜åŒ–**ï¼šè™šæ‹Ÿçª—å£ã€åŠæ—¶æ¸…ç†
4. **ä½“éªŒä¼˜åŒ–**ï¼šæ»šåŠ¨æ¢å¤ã€éª¨æ¶å±ã€æå‰åŠ è½½
5. **é¦–å±ä¼˜åŒ–**ï¼šLCP ä¼˜åŒ–ã€å›¾ç‰‡é¢„åŠ è½½ã€startTransitionï¼ˆæ–°å¢ï¼‰â­ï¸â­ï¸â­ï¸
6. **è·¯ç”±ä¼˜åŒ–**ï¼šè·¯ç”±æ‡’åŠ è½½ï¼ˆæ‰€æœ‰é¡µé¢ä½¿ç”¨ React.lazyï¼‰ï¼ˆæ–°å¢ï¼‰â­ï¸â­ï¸

### 8.3 è®¾è®¡æ¨¡å¼åº”ç”¨

1. **æœåŠ¡å±‚æ¨¡å¼**ï¼šAPI è°ƒç”¨æŠ½è±¡
2. **å®¹å™¨/å±•ç¤ºç»„ä»¶**ï¼šå…³æ³¨ç‚¹åˆ†ç¦»
3. **è‡ªå®šä¹‰ Hooks**ï¼šé€»è¾‘å¤ç”¨
4. **çŠ¶æ€æå‡**ï¼šå…±äº«çŠ¶æ€ç®¡ç†
5. **èµ„æºç®¡ç†**ï¼šæ´»åŠ¨èµ„æºç®¡ç†ç³»ç»Ÿï¼ˆæ–°å¢ï¼‰â­ï¸â­ï¸

### 8.4 é¡¹ç›®äº®ç‚¹

- âœ… é«˜æ€§èƒ½ï¼šè™šæ‹Ÿçª—å£æœºåˆ¶ï¼ŒDOM èŠ‚ç‚¹å‡å°‘ 95%+
- âœ… ç”¨æˆ·ä½“éªŒï¼šæ»šåŠ¨æ¢å¤ã€è‡ªåŠ¨æ’­æ”¾ã€åˆ‡æ¢åŠ¨ç”»
- âœ… ä»£ç è´¨é‡ï¼šæ¸…æ™°çš„æ¶æ„ã€å®Œå–„çš„é”™è¯¯å¤„ç†
- âœ… å¯ç»´æŠ¤æ€§ï¼šæ¨¡å—åŒ–è®¾è®¡ã€æ˜“äºæ‰©å±•
- âœ… æ´»åŠ¨èµ„æºç®¡ç†ï¼šå®Œæ•´çš„æ´»åŠ¨ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§å±•ç¤ºæ–¹å¼ï¼ˆæ–°å¢ï¼‰â­ï¸â­ï¸
- âœ… é¦–å±æ€§èƒ½ï¼šLCP ä¼˜åŒ–ã€å›¾ç‰‡é¢„åŠ è½½ã€React 18 æ€§èƒ½ä¼˜åŒ–ï¼ˆæ–°å¢ï¼‰â­ï¸â­ï¸â­ï¸

---

## ä¹ã€æœ€æ–°æ›´æ–°ï¼ˆ2025å¹´1æœˆï¼‰

### 9.1 æ–°å¢åŠŸèƒ½

1. **æ´»åŠ¨èµ„æºç®¡ç†ç³»ç»Ÿ** â­ï¸â­ï¸
   - å®Œæ•´çš„æ´»åŠ¨ CRUD åŠŸèƒ½
   - Banner è½®æ’­ç»„ä»¶
   - å¼¹çª—ç»„ä»¶
   - æ´»åŠ¨èµ„æºåŠ è½½æœåŠ¡

2. **React 18 æ€§èƒ½ä¼˜åŒ–** â­ï¸â­ï¸â­ï¸
   - startTransition API åº”ç”¨
   - LCP ä¼˜åŒ–ç­–ç•¥
   - å›¾ç‰‡é¢„åŠ è½½ä¼˜åŒ–

3. **è·¯ç”±æ‡’åŠ è½½** â­ï¸â­ï¸
   - æ‰€æœ‰é¡µé¢ä½¿ç”¨ React.lazy
   - Suspense åŠ è½½çŠ¶æ€

### 9.2 æ€§èƒ½æå‡

- **LCP æŒ‡æ ‡**ï¼šé€šè¿‡ä¼˜å…ˆåŠ è½½é¡¶éƒ¨ Banner å’Œå›¾ç‰‡é¢„åŠ è½½ï¼Œæ˜¾è‘—æå‡ LCP
- **é¦–å±åŠ è½½**ï¼šä½¿ç”¨ startTransition å»¶è¿Ÿéå…³é”®å†…å®¹ï¼Œä¼˜å…ˆæ¸²æŸ“å…³é”®å…ƒç´ 
- **åŒ…ä½“ç§¯**ï¼šè·¯ç”±æ‡’åŠ è½½å‡å°‘åˆå§‹åŒ…ä½“ç§¯

### 9.3 æŠ€æœ¯æ ˆæ›´æ–°

- React 18.2.0ï¼ˆæ”¯æŒ Concurrent Modeï¼‰
- Ant Design 5.28.1ï¼ˆUI ç»„ä»¶åº“ï¼‰
- æ–°å¢æ´»åŠ¨èµ„æºç®¡ç†æœåŠ¡å±‚

---

**æ–‡æ¡£å®Œæˆæ—¶é—´**ï¼š2025å¹´1æœˆ

**æœ€åæ›´æ–°**ï¼š2025å¹´1æœˆï¼ˆæ·»åŠ æ´»åŠ¨èµ„æºç®¡ç†ç³»ç»Ÿã€React 18 æ€§èƒ½ä¼˜åŒ–ã€è·¯ç”±æ‡’åŠ è½½ï¼‰

**é¡¹ç›®ä»“åº“**ï¼š[NgHuuTrong/tiktok-frontend](https://github.com/NgHuuTrong/tiktok-frontend.git)

**æ”¹é€ è¯´æ˜**ï¼šæœ¬æ–‡æ¡£åŸºäºå…‹éš†çš„åŸå§‹ä»“åº“ï¼Œè®°å½•äº†æ·±åº¦æ”¹é€ åçš„ä»£ç å®ç°å’Œä¼˜åŒ–ç­–ç•¥ï¼ŒåŒ…æ‹¬æœ€æ–°çš„æ´»åŠ¨èµ„æºç®¡ç†ç³»ç»Ÿå’Œæ€§èƒ½ä¼˜åŒ–å®è·µã€‚

